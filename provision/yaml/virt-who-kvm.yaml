- defaults:
    name: virt-who-provision
    description: |
        Managed by Jenkins Job Builder. Do not edit via web.
    concurrent: true
    scm:
        - git:
            url: 'https://github.com/shihliu/entitlement-ci'
            branches:
                - origin/master
            basedir: entitlement-ci
    wrappers:
        - default-virt-who-wrappers

- defaults:
    name: virt-who-runtest
    description: |
        Managed by Jenkins Job Builder. Do not edit via web.
    concurrent: true
    scm:
        - git:
            url: 'https://github.com/shihliu/entitlement-ci'
            branches:
                - origin/master
            basedir: entitlement-ci
    wrappers:
        - default-virt-who-wrappers

- wrapper:
    name: default-virt-who-wrappers
    wrappers:
        - ansicolor
        - workspace-cleanup
        - timestamps

- publisher:
    name: default-virt-who-runtest-publishers
    publishers:
    - xunit:
        thresholdmode: number
        thresholds:
        - failed:
            unstable: 0
            unstablenew: 0
            failure: 0
            failurenew: 0
        - skipped:
            unstable: 0
            unstablenew: 0
            failure: 0
            failurenew: 0
        types:
        - junit:
            pattern: '*.xml'
            deleteoutput: false

- publisher:
    name: default-virt-who-publishers
    publishers:
    - email-ext:
        recipients: shihliu@redhat.com
        reply-to: shihliu@redhat.com
        content-type: default
        subject: '[Entitlement-CI]($SERVER_TYPE) $PROJECT_NAME on $VIRTWHO_ORIGINAL_SRC -
          $BUILD_STATUS!'
        body: |-
          [$SERVER_TYPE] $PROJECT_NAME on $RHEL_COMPOSE $REMOTE_HOSTNAME $VIRTWHO_ORIGINAL_SRC- Build # $BUILD_NUMBER - $BUILD_STATUS:

          Runtime Info As Follows:

          Test Packages
          $VIRTWHO_VERSION
          $RHSM
          $PYTHON_RHSM

          export RHEL_COMPOSE=$RHEL_COMPOSE
          export REMOTE_IP=$REMOTE_IP
          export REMOTE_HOSTNAME=$REMOTE_HOSTNAME
          export VIRTWHO_SRC=$VIRTWHO_ORIGINAL_SRC
          export SERVER_TYPE=$SERVER_TYPE
          export SERVER_IP=$SERVER_IP
          export SERVER_HOSTNAME=$SERVER_HOSTNAME
          export SERVER_COMPOSE=$SERVER_COMPOSE
          export HYPERVISOR_TYPE=remote_libvirt

          Details:

          Check console output at $BUILD_URL
          Check text log at ${BUILD_URL}consoleText/
          Check report at ${BUILD_URL}testReport/
        attach-build-log: false
        always: true
        send-to:
        - requester
        - recipients

- job-template:
    name: virt-who-remote-libvirt-runtest
    defaults: virt-who-runtest
    node: 'rhel-slave'
    builders:
    #- copyartifact:
    #    project: virt-who-esx-provision
    #    filter: '*.txt, *.json'
    #    target: $WORKSPACE
    - shell: |
        #!/bin/bash
        echo "Jenkins machine info we are running on"
        echo "Pinging Test Resources"
        cat $WORKSPACE/RESOURCES.txt
        echo REMOTE_IP=$REMOTE_IP
        echo VIRTWHO_ORIGINAL_SRC=$VIRTWHO_ORIGINAL_SRC
        echo VIRTWHO_SRC=$VIRTWHO_SRC
        export REMOTE_IP=10.66.129.77
        export REMOTE_IP_2=10.66.129.148
        export HYPERVISOR_TYPE=remote_libvirt
        echo "*********************************setup env*********************************"
        #setup environment here to run alone, change back when finished
        #export RHEL_COMPOSE=
        #export SERVER_IP=
        #export SERVER_TYPE=
        #export SERVER_HOSTNAME=
        echo "*********************************setup env*********************************"
        pushd $WORKSPACE/entitlement-ci/testcases/virt_who/
          nosetests virtwho_remote_libvirt_setup.py --with-xunit --xunit-file=$WORKSPACE/nosetests.xml
        popd
        pushd $WORKSPACE/entitlement-ci/testcases/virt_who/all/
          nosetests *.py --with-xunit --xunit-file=$WORKSPACE/nosetests.xml
        popd 
        echo "************************check trigger condition of another remote libvirt*****************" 
        #if [ "$RHEL_COMPOSE_EXIST"x = ""x ]
        if [ "$RHEL_COMPOSE" == "release" ]
        then 
          if [ "$VIRTWHO_SRC"x = "default"x ] 
          then
          #  echo VIRTWHO_SRC=rhel6.8-sattool>>$WORKSPACE/REMOTE_LIBVIRT_NEWRUN.txt
          #  export VIRTWHO_SRC=rhel6.8-sattool
          #elif [ "$VIRTWHO_SRC"x = "rhel6.8-sattool"x ]
          #then
             export VIRTWHO_SRC=rhel7.3-sattool
             echo VIRTWHO_SRC=rhel7.3-sattool>>$WORKSPACE/REMOTE_LIBVIRT_NEWRUN.txt
          elif [ "$VIRTWHO_SRC"x = "rhel7.3-sattool"x ]
          then
             export VIRTWHO_SRC=rhel6.9-original
             echo VIRTWHO_SRC=rhel6.9-original>>$WORKSPACE/REMOTE_LIBVIRT_NEWRUN.txt         
          elif [ "$VIRTWHO_SRC"x = "rhel6.9-original"x ]
          then
          #   export VIRTWHO_SRC=rhel6.8-original
          #   echo VIRTWHO_SRC=rhel6.8-original>>$WORKSPACE/REMOTE_LIBVIRT_NEWRUN.txt   
          #elif [ "$VIRTWHO_SRC"x = "rhel6.8-original"x ]
          #then
             export VIRTWHO_SRC=rhel7.3-original
             echo VIRTWHO_SRC=rhel7.3-original>>$WORKSPACE/REMOTE_LIBVIRT_NEWRUN.txt 
             export RHEL_COMPOSE_EXIST=True
             echo RHEL_COMPOSE_EXIST=True>>$WORKSPACE/REMOTE_LIBVIRT_NEWRUN.txt
          else
             export VIRTWHO_ORIGINAL_SRC=rhel7.3-original
             rm -rf $WORKSPACE/REMOTE_LIBVIRT_NEWRUN.txt
          fi
        else
          export VIRTWHO_ORIGINAL_SRC=$VIRTWHO_SRC
          rm -rf $WORKSPACE/REMOTE_LIBVIRT_NEWRUN.txt
        fi 
        echo "VIRTWHO_SRC is"$VIRTWHO_SRC
        echo "VIRTWHO_ORIGINAL_SRC is "$VIRTWHO_ORIGINAL_SRC
        echo "RHEL_COMPOSE_EXIST is "$RHEL_COMPOSE_EXIST
        echo "********************************runtime env********************************"
        env | grep -E '(REMOTE_IP|REMOTE_HOSTNAME|SERVER_TYPE|SERVER_COMPOSE|VIRTWHO_SRC|VIRTWHO_ORIGINAL_SRC|SERVER_IP|SERVER_HOSTNAME|RHEL_COMPOSE|RHEL_COMPOSE_EXIST)' | sort | xargs -i -d "\n" echo {{}} | tee -a $WORKSPACE/RUNTIME_INFO.txt
        env | grep -E '(REMOTE_IP|REMOTE_HOSTNAME|SERVER_TYPE|SERVER_COMPOSE|VIRTWHO_SRC|VIRTWHO_ORIGINAL_SRC|SERVER_IP|SERVER_HOSTNAME|RHEL_COMPOSE|RHEL_COMPOSE_EXIST)' | sort | xargs -i -d "\n" echo "export" {{}}
        env | grep -E '(REMOTE_IP|REMOTE_HOSTNAME|SERVER_TYPE|SERVER_COMPOSE|VIRTWHO_SRC|VIRTWHO_ORIGINAL_SRC|SERVER_IP|SERVER_HOSTNAME|RHEL_COMPOSE|RHEL_COMPOSE_EXIST)' >> $WORKSPACE/RESOURCES.txt
        echo "********************************runtime env********************************"
    - inject:
        properties-file: $WORKSPACE/RUNTIME_INFO.txt
    - inject:
        properties-file: $WORKSPACE/RESOURCES.txt
    - inject:
        properties-file: $WORKSPACE/REMOTE_LIBVIRT_NEWRUN.txt
    publishers:
    - archive:
        artifacts: '**/**'
        allow-empty: 'true'
    - default-virt-who-runtest-publishers
    - default-virt-who-publishers
    - trigger-parameterized-builds:
      - project: virt-who-remote-libvirt-runtest
        property-file: $WORKSPACE/RESOURCES.txt,$WORKSPACE/REMOTE_LIBVIRT_NEWRUN.txt
        fail-on-missing: true
        current-parameters: false
        #condition: ALWAYS
          
- job-group:
    name: virt-who-kvm-provision-runtest
    jobs:
    - virt-who-remote-libvirt-runtest
- project:
    name: virt-who-kvm-jobs
    project: virt-who-kvm
    project_defaults: entitlement-ci/config/project_defaults
    topology_path: entitlement-ci/config
    topology: bkr_build_single_provision_no_hvm
    ssh_keyfile: entitlement-ci/config/keys/ent-key
    beaker_keyfile: entitlement-ci/config/keys/beaker-key
    tests_path: entitlement-ci/tests
    testparams: echo "I am a test parameter"
    jobs:
    - virt-who-remote-libvirt-runtest
    polarion_template: virt-who for kvm auto template
